name: Build and Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # 3. Install dependencies
      - name: Install dependencies
        run: npm install

      # 4. Fetch latest release version from GitHub
      - name: Read latest version from GitHub Releases
        id: ghver
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¥ Fetching latest GitHub release..."
          LATEST=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')

          if [ -z "$LATEST" ]; then
            echo "âš  No releases found. Using package.json version."
            echo "latest=none" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Remove prefix 'v'
          CLEAN=${LATEST#v}

          echo "latest=$CLEAN" >> $GITHUB_OUTPUT
          echo "Latest GitHub release version = $CLEAN"

      # 5. Sync package.json version to GitHub release version (if exists)
      - name: Sync package.json version to GitHub latest
        if: steps.ghver.outputs.latest != 'none'
        shell: bash
        run: |
          LATEST=${{ steps.ghver.outputs.latest }}
          echo "ðŸ”„ Syncing package.json version â†’ $LATEST"

          # Overwrite package.json version
          node -e "
          let fs=require('fs');
          let pj=require('./package.json');
          pj.version='$LATEST';
          fs.writeFileSync('./package.json', JSON.stringify(pj,null,2));
          "

      # 6. Clean git working directory
      - name: Clean untracked files
        run: |
          git reset --hard
          git clean -fd

      # 7. Delete existing tag if exists
      - name: Delete existing tag
        shell: bash
        run: |
          NEW="v$(node -p "require('./package.json').version")"

          if git ls-remote --tags origin | grep -q "refs/tags/$NEW"; then
            git push --delete origin $NEW || true
          fi

          if git tag | grep -q "$NEW"; then
            git tag -d $NEW || true
          fi

      # 8. Bump version (patch)
      - name: Bump version
        id: bump
        run: |
          npm version patch -m "chore: bump version to %s"

      # 9. Push changes
      - name: Push changes
        run: git push origin main --follow-tags

      # 10. Build Electron app
      - name: Build Electron app
        run: npm run dist:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 11. Create Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.bump.outputs.newversion }}
          name: Release ${{ steps.bump.outputs.newversion }}
          files: |
            release/*.exe
            release/*.exe.blockmap
            release/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12. Upload CI artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: release/
