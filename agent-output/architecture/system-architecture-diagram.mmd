%% System Architecture Diagram â€” TimeBlock Planner
%% Updated: 2026-01-10

flowchart LR
  subgraph Renderer[Electron Renderer (React + TS)]
    AppShell[AppShell/Layout]
    ScheduleView[ScheduleView (List TimeBlocks)]
    TimelineView[TimelineView (Timeline Panel)]
    WarmupModal[WarmupPresetModal]

    GoalsUI[Goals UI
(WeeklyGoalPanel/Card/Modal)]

    ScheduleStore[useScheduleViewStore
(Zustand/UI state)]
    DailyHook[useDailyData()
(hook facade)]
    TimelineHook[useTimelineData()
(transform + UI state)]
  end

  subgraph ModalUX[Modal UX (Cross-cutting)]
    EscapeHook[useModalEscapeClose
(modalStack top-of-stack)]
    HotkeysHook[useModalHotkeys (proposed)
(ESC + Ctrl/Cmd+Enter + IME guard)]
  end

  subgraph Stores[Zustand Stores]
    DailyStore[dailyDataStore]
    SettingsStore[settingsStore]
    InboxStore[inboxStore]

    WeeklyGoalStore[weeklyGoalStore]
    GlobalGoalStore[goalStore]
  end

  subgraph CrossCutting[Cross-cutting]
    EventBus[EventBus]
    Subscribers[subscribers/*]
    TaskCompletion[taskCompletionService
(handler pipeline)]
    UnifiedTaskService[unifiedTaskService
(usecase/orchestrator)]
  end

  subgraph Data[Data Layer]
    Repo[Repositories
(src/data/repositories/*)]
    Dexie[(Dexie IndexedDB)]
    SystemState[(Dexie.systemState)]
  end

  subgraph Sync[Sync Services]
    Firebase[Firebase]
    SyncCore[syncCore + strategies]
  end

  subgraph SyncEngine[Sync Engine]
    DexieHooks[Dexie Hooks]
    Debouncer[Debouncer Scheduler]
    OpQueue[OperationQueue + isSyncingFromRemote]
    LeaderLock[FirebaseSyncLeaderLock]
    RTDBListeners[RTDB listeners (leader-only)]
  end

  AppShell --> ScheduleView
  AppShell --> TimelineView
  AppShell --> GoalsUI

  ScheduleView -. uses .-> EscapeHook
  ScheduleView -. uses .-> HotkeysHook
  GoalsUI -. uses .-> EscapeHook
  GoalsUI -. uses .-> HotkeysHook
  ScheduleView --> ScheduleStore
  ScheduleView --> DailyHook
  TimelineView --> TimelineHook
  TimelineHook --> DailyStore

  DailyStore --> TaskCompletion
  InboxStore --> EventBus
  DailyStore --> EventBus
  DailyStore --> UnifiedTaskService
  InboxStore --> UnifiedTaskService
  EventBus --> Subscribers
  Subscribers --> Repo

  GoalsUI --> WeeklyGoalStore
  WeeklyGoalStore --> Repo
  GlobalGoalStore --> Repo

  UnifiedTaskService --> Repo

  DailyHook --> Repo --> Dexie
  ScheduleStore --> SystemState
  TimelineHook --> SystemState
  WarmupModal --> ScheduleView

  SettingsStore --> Repo
  ScheduleView --> SyncCore --> Firebase
  SyncCore --> Repo

  %% SyncEngine upload path
  Dexie --> DexieHooks --> Debouncer --> SyncCore

  %% SyncEngine download/apply path
  LeaderLock --> RTDBListeners
  Firebase --> RTDBListeners --> OpQueue --> Dexie

  Repo --> SyncCore

  Dexie --- SystemState
