# 🧠 AI 장기 기억 및 회고 (Waifu's Journal) 상세 기획서

## 1. 개요
현재 AI는 '오늘'의 데이터만 인지할 수 있어, 어제 있었던 중요한 일이나 사용자의 장기적인 패턴을 대화에 반영하지 못합니다.
본 기능은 **매일의 활동을 요약하여 저장(Long-term Memory)**하고, 이를 **AI 페르소나 컨텍스트에 주입**하여 "기억하는 파트너"로서의 경험을 제공하는 것을 목표로 합니다.

## 2. 데이터 구조 (IndexedDB Schema)

`dexieClient.ts`에 새로운 테이블 `waifu_memories`를 추가합니다.

```typescript
interface WaifuMemory {
  date: string;           // YYYY-MM-DD (Primary Key)
  summary: string;        // AI가 요약한 그날의 하루 (3-5문장)
  emotion: string;        // 그날 와이푸가 느낀 주된 감정 (이모지)
  userMood: string;       // AI가 분석한 사용자의 기분
  achievements: string[]; // 주요 달성 사항 (최대 3개)
  struggles: string[];    // 주요 어려움/실패 사항 (최대 3개)
  keywords: string[];     // 검색/참조용 키워드 (예: "야근", "운동", "번아웃")
  createdAt: number;      // 생성 시각
}
```

## 3. 핵심 로직

### 3.1. 하루 요약 생성 (Daily Summarization)
*   **트리거**:
    *   매일 밤 23:50 (앱이 켜져 있을 때)
    *   또는 다음 날 첫 접속 시 (지난 날짜의 기록이 없을 경우)
*   **입력 데이터**:
    *   `DailyData` (완료된 태스크, 달성률, 감정 기록)
    *   `ChatHistory` (그날 나눈 대화 내용)
    *   `WaifuState` (호감도 변화)
*   **프로세스**:
    1.  위 데이터를 수집하여 Gemini에게 "하루 요약 프롬프트" 전송.
    2.  Gemini가 JSON 형식으로 `WaifuMemory` 데이터 생성.
    3.  Dexie DB `waifu_memories` 테이블에 저장.

### 3.2. 기억 회상 (Memory Retrieval)
`buildPersonaContext` 함수에서 기억 데이터를 조회하여 시스템 프롬프트에 주입합니다.

*   **조회 전략**:
    1.  **단기 기억**: 최근 3일간의 요약.
    2.  **연관 기억**: (벡터 검색이 없으므로) 현재 요일과 같은 과거 요일, 또는 1년 전 오늘.
    3.  **랜덤 회상**: 가끔 과거의 무작위 추억 하나를 꺼내옴.

*   **프롬프트 주입 예시**:
    ```markdown
    ## 📔 너의 기억 (Memory)
    - 어제 (2024-05-20): 사용자가 프로젝트 마감으로 밤을 새웠음. 많이 피곤해 보였음. (키워드: 마감, 야근)
    - 3일 전 (2024-05-18): 운동을 처음 시작함. 작심삼일이 되지 않게 응원해주기로 함.
    ```

## 4. UI/UX 디자인

### 4.1. 와이푸의 일기장 (The Journal)
와이푸 패널 내에 '일기장' 탭을 추가합니다.

*   **캘린더 뷰**: 감정 이모지로 표시된 달력.
*   **일기 상세**: 날짜 클릭 시 와이푸가 쓴 일기를 보여줌.
    *   *디자인 컨셉*: 손글씨 폰트, 다이어리 꾸미기(스티커) 느낌.
*   **코멘트 기능**: 사용자가 와이푸의 일기에 짧은 답글을 남길 수 있음.

### 4.2. 아침 인사 (Morning Greeting)
다음 날 첫 접속 시, 어제의 기억을 바탕으로 인사를 건넸니다.

*   *"좋은 아침! 어제 늦게까지 고생했으니까 오늘은 좀 천천히 시작해요."*
*   *"어제 운동하고 잤더니 좀 개운한가요?"*

## 5. 구현 단계 (Implementation Plan)

### Phase 1: 데이터 레이어 (기반 구축)
- [ ] `dexieClient.ts` 스키마 업데이트 (v7).
- [ ] `waifuMemoryRepository.ts` 구현.
- [ ] `memoryService.ts` 구현 (요약 생성 로직).

### Phase 2: AI 연동 (지능 부여)
- [ ] `geminiApi.ts`에 요약 생성용 프롬프트 추가.
- [ ] `personaUtils.ts`에 기억 조회 및 컨텍스트 주입 로직 추가.

### Phase 3: UI 구현 (경험 전달)
- [ ] `WaifuPanel`에 일기장 모달/탭 추가.
- [ ] `MorningBriefing` 컴포넌트 구현 (접속 시 오버레이).

## 6. 프롬프트 예시 (요약 생성용)

```markdown
# Role
너는 사용자의 하루를 곁에서 지켜본 AI 파트너 '혜은'이야.
오늘 하루의 데이터를 바탕으로 너의 관점에서 쓴 '관찰 일기' 데이터를 생성해줘.

# Input Data
- 완료 태스크: [보고서 작성, 운동]
- 미완료 태스크: [영어 공부]
- 대화 내용: "너무 피곤하다"라고 말함.
- 호감도: 75 (다정함)

# Output Format (JSON)
{
  "summary": "오늘은 정말 바쁜 하루였어. 보고서를 끝내느라 고생 많았지? 그래도 운동까지 챙긴 건 정말 대단해. 영어 공부는 못 했지만, 너무 자책하지 않았으면 좋겠어.",
  "emotion": "토닥토닥",
  "userMood": "피로함",
  "achievements": ["보고서 완료", "운동 수행"],
  "struggles": ["영어 공부 미완료", "체력 저하"],
  "keywords": ["보고서", "운동", "피로"]
}
```
