# 과거 데이터 요약 및 전달 방식 분석 보고서

사용자님의 지적대로, 현재 시스템이 과거 데이터를 AI에게 전달하는 방식에는 **"맥락(Context)의 부재"**라는 치명적인 약점이 있습니다. 이를 분석하고 개선안을 제시합니다.

## 1. 현재 상황 분석 (As-Is)

현재 `geminiApi.ts`에서 과거 데이터를 프롬프트로 변환하는 로직을 정밀 분석했습니다.

### 1.1. 전달되는 정보의 한계
*   **타임블록 패턴**: `recentBlockPatterns` 데이터를 사용하지만, 프롬프트에는 **"5일간 평균 N개 완료"**라는 **단순 평균값**만 전달됩니다.
    *   ❌ **문제**: AI는 어제 내가 "무엇"을 했는지 전혀 모릅니다. "어제 코딩하느라 고생했네" 같은 말을 절대 할 수 없습니다.
*   **XP 히스토리**: `날짜: XP` 형태의 단순 숫자 목록만 전달됩니다.
    *   ❌ **문제**: XP가 낮았던 날, "아파서 쉬었는지" 아니면 "놀았는지" 알 수 없습니다.
*   **최근 작업**: 전체 작업 중 가장 최근 5개만 전달됩니다.
    *   ❌ **문제**: 어제 완료한 중요한 프로젝트는 이미 리스트에서 밀려나 AI의 기억에서 사라졌을 가능성이 높습니다.

### 1.2. 결론
현재 AI는 **"과거의 통계(Stats)"는 알지만, "과거의 사건(Events)"은 모르는 상태**입니다. 따라서 "기억"을 가진 파트너가 아니라, 단순히 "통계청 직원"처럼 행동할 수밖에 없습니다.

---

## 2. 개선 제안: 의미 기반 요약 (Semantic Summarization)

AI가 과거를 "이야기"로 기억할 수 있도록, **데이터 압축(Compression)** 전략을 변경해야 합니다.

### 2.1. "통계" 대신 "사건" 위주 요약
숫자 평균을 보내는 대신, **"그날의 핵심 사건 요약문"**을 생성하여 저장하고 이를 전달해야 합니다.

#### [변경 전]
```text
- 최근 5일 평균: 2.5개 완료
- 어제 XP: 120
```

#### [변경 후] (AI에게 전달될 프롬프트 예시 - 4주 분량)
```text
## 📜 최근 4주간의 기억

### 1주차 (상세 요약)
- **11/18 (어제)**: 리액트 컴포넌트 리팩토링에 몰입(Flow). 목표 초과 달성했으나 저녁엔 번아웃. [감정: 🔥→💧] [목표: 프로젝트A] [사건: 목표초과, 번아웃]
- **11/17**: 영어 공부를 계속 미루다 실패. 자책감. [감정: 😔] [사건: 미루기, 실패]
- **11/16**: 주말 휴식. 에너지 충전 완료. [감정: 😌] [사건: 휴식]

### 2주차 (Key 요약 + 시간대)
- **11/11**: 자격증 기출문제 풀이 완료. [08-11시: 공부, 14-17시: 운동]
- **11/10**: 프로젝트 마감으로 야근. [17-20시: 코딩, 20-23시: 디버깅]

### 3-4주차 (핵심 사건만)
- **11/04**: [목표초과달성] 일주일 치 계획 완수
- **10/28**: [지각] 오전 10시까지 아무것도 안 함
- **10/22**: [정서적 고점] 첫 자격증 합격 소식
```

### 2.2. 상세 구현 전략 (Detailed Strategy)

이 "요약문"을 어떻게 만들 것인가가 핵심입니다. 단순한 텍스트 요약을 넘어, **구조화된 기억(Structured Memory)**을 구축해야 합니다.

#### A. 요약 생성 프롬프트 (The Summarizer)
매일 밤 Gemini에게 다음과 같은 지침으로 요약을 요청합니다.

> "오늘의 데이터를 분석해서 다음 3가지 관점으로 3줄 요약을 작성해줘."
> 1.  **Fact (사실)**: 무엇을 했는가? (주요 작업, 달성률)
> 2.  **Emotion (감정)**: 사용자의 기분은 어땠는가? (대화 내용, 작업 패턴 기반 추론)
> 3.  **Insight (통찰)**: 장기 목표(Global Goals)와 어떻게 연결되는가? 실패했다면 원인은 무엇인가?

#### B. 기억의 구조화 (Memory Schema)
단순 문자열 대신, 검색과 참조가 용이한 형태로 저장합니다.

```typescript
interface DailyMemory {
  date: string;
  summary: string;        // "리액트 리팩토링으로 불태웠지만, 저녁엔 번아웃이 옴."
  primaryEmotion: string; // "🔥 열정", "💧 지침", "🎉 성취"
  relatedGoals: string[]; // ["자격증", "프로젝트A"]
  keyEvents: string[];    // ["지각", "목표초과달성", "운동쉼"]
}
```

#### C. Rolling Context (순환 컨텍스트) - 4주 전략
프롬프트에 주입할 때 **4주 분량**의 데이터를 계층적으로 전달합니다.

*   **1주차 (최근 7일)**: 상세 요약 전체
    *   `summary` (3줄 요약문)
    *   `primaryEmotion` (주요 감정)
    *   `relatedGoals` (연관 목표)
    *   `keyEvents` (핵심 사건)
*   **2주차 (8-14일 전)**: Key 요약 (작업 시간대 포함)
    *   `summary` (1줄 요약)
    *   주요 작업이 **어떤 시간대(TimeBlock)**에 처리됐는지
    *   예: "08-11시에 리액트 스터디, 14-17시에 운동"
*   **3-4주차 (15-28일 전)**: 핵심 사건만
    *   `keyEvents`만 추출 (예: "목표초과달성", "지각", "번아웃")
    *   특별한 패턴이 있었던 날만 선택적으로 언급

### 2.3. 토큰 효율성 및 정확도
*   **기존**: 숫자 데이터 나열 (약 100-200 토큰) -> 정보량 낮음, 맥락 없음.
*   **개선**: 구조화된 요약 (약 150-250 토큰) -> **정보 밀도 높음, AI가 '공감'할 포인트 제공.**
*   **정확도 확보**: 요약 생성 시 `GlobalGoals` 정보를 함께 주입하여, 단순 작업 나열이 아닌 **"꿈을 향한 과정"**으로 해석하도록 유도합니다.

## 3. 실행 계획

이 "의미 기반 요약" 시스템을 구축하기 위해 다음 작업을 제안합니다.

1.  **요약 생성기 구현**: `summarizeDailyActivity(dailyData)` 함수 구현 (Gemini API 연동).
2.  **기억 저장소 구축**: `waifu_memories` 테이블 생성 및 저장 로직.
3.  **프롬프트 개편**: 통계 수치 나열을 줄이고, `memoryService.getRecentSummaries()`를 통해 가져온 텍스트 요약을 주입.

이 방향으로 "과거 데이터 인지 능력"을 개선하는 것이 어떻습니까?
