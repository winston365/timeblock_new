<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TimeBlock ë°ì´í„° ì§„ë‹¨ ë„êµ¬</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
    h1 { color: #4ec9b0; }
    h2 { color: #ce9178; margin-top: 30px; }
    pre { background: #2d2d2d; padding: 15px; border-radius: 5px; overflow-x: auto; }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #dcdcaa; }
    button { background: #0e639c; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 3px; }
    button:hover { background: #1177bb; }
    .section { margin: 20px 0; border: 1px solid #3e3e3e; padding: 15px; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>ğŸ” TimeBlock ë°ì´í„° ì§„ë‹¨ ë„êµ¬</h1>
  <button onclick="diagnoseAll()">ì „ì²´ ì§„ë‹¨ ì‹¤í–‰</button>
  <button onclick="exportData()">ë°ì´í„° ë°±ì—…</button>

  <div class="section">
    <h2>1. localStorage í™•ì¸</h2>
    <pre id="localStorage-output">ë¡œë”© ì¤‘...</pre>
  </div>

  <div class="section">
    <h2>2. IndexedDB í™•ì¸</h2>
    <pre id="indexedDB-output">ë¡œë”© ì¤‘...</pre>
  </div>

  <div class="section">
    <h2>3. Firebase ì„¤ì • í™•ì¸</h2>
    <pre id="firebase-output">ë¡œë”© ì¤‘...</pre>
  </div>

  <div class="section">
    <h2>4. ë³µêµ¬ ê°€ëŠ¥í•œ ë°ì´í„°</h2>
    <pre id="recovery-output">ë¡œë”© ì¤‘...</pre>
  </div>

  <script>
    async function checkLocalStorage() {
      const output = document.getElementById('localStorage-output');
      let html = '';

      const allKeys = Object.keys(localStorage);
      html += `ì´ ${allKeys.length}ê°œì˜ í‚¤ ë°œê²¬\n\n`;

      // ëª¨ë“  í‚¤ í‘œì‹œ
      const relevantKeys = allKeys.filter(key =>
        key.includes('daily') ||
        key.includes('Daily') ||
        key.includes('plan') ||
        key.includes('Plan') ||
        key.includes('game') ||
        key.includes('Game') ||
        key.includes('settings') ||
        key.includes('Settings')
      );

      if (relevantKeys.length === 0) {
        html += '<span class="error">âŒ ê´€ë ¨ ë°ì´í„° ì—†ìŒ</span>\n\n';
        html += 'ì „ì²´ í‚¤ ëª©ë¡:\n';
        allKeys.forEach(key => {
          html += `  - ${key}\n`;
        });
      } else {
        html += '<span class="success">âœ… ê´€ë ¨ ë°ì´í„° ë°œê²¬:</span>\n\n';
        relevantKeys.forEach(key => {
          try {
            const value = localStorage.getItem(key);
            const parsed = JSON.parse(value);
            html += `ğŸ“¦ ${key}:\n`;
            if (parsed.tasks) {
              html += `   â”” í• ì¼: ${parsed.tasks.length}ê°œ\n`;
              parsed.tasks.forEach((task, idx) => {
                html += `      ${idx+1}. ${task.text || task.title || '(ì œëª©ì—†ìŒ)'}\n`;
              });
            } else {
              html += `   â”” ${JSON.stringify(parsed, null, 2)}\n`;
            }
            html += '\n';
          } catch (e) {
            html += `  ${key}: (íŒŒì‹± ì‹¤íŒ¨)\n`;
          }
        });
      }

      output.innerHTML = html;
    }

    async function checkIndexedDB() {
      const output = document.getElementById('indexedDB-output');
      let html = '';

      try {
        const request = indexedDB.open('timeblock_db', 2);

        request.onsuccess = async (event) => {
          const db = event.target.result;
          html += `<span class="success">âœ… Database: ${db.name} (v${db.version})</span>\n`;
          html += `Object Stores: ${Array.from(db.objectStoreNames).join(', ')}\n\n`;

          // dailyData í™•ì¸
          try {
            const tx = db.transaction(['dailyData'], 'readonly');
            const store = tx.objectStore('dailyData');
            const all = store.getAll();

            all.onsuccess = () => {
              html += `ğŸ“… dailyData: ${all.result.length}ê°œ ë ˆì½”ë“œ\n`;
              all.result.forEach(item => {
                html += `  - ${item.date}: ${item.tasks?.length || 0}ê°œ í• ì¼\n`;
                if (item.tasks && item.tasks.length > 0) {
                  item.tasks.forEach((task, idx) => {
                    html += `     ${idx+1}. ${task.text}\n`;
                  });
                }
              });
              html += '\n';

              // gameState í™•ì¸
              const tx2 = db.transaction(['gameState'], 'readonly');
              const store2 = tx2.objectStore('gameState');
              const gameAll = store2.getAll();

              gameAll.onsuccess = () => {
                html += `ğŸ® gameState: ${gameAll.result.length}ê°œ ë ˆì½”ë“œ\n`;
                if (gameAll.result.length > 0) {
                  const gs = gameAll.result[0];
                  html += `  Level: ${gs.level}, XP: ${gs.totalXP}\n`;
                }

                output.innerHTML = html;
              };
            };
          } catch (e) {
            html += `<span class="error">âŒ Error: ${e.message}</span>\n`;
            output.innerHTML = html;
          }
        };

        request.onerror = () => {
          output.innerHTML = '<span class="error">âŒ IndexedDB ì—´ê¸° ì‹¤íŒ¨</span>';
        };
      } catch (error) {
        output.innerHTML = `<span class="error">âŒ Error: ${error.message}</span>`;
      }
    }

    async function checkFirebase() {
      const output = document.getElementById('firebase-output');

      const settings = localStorage.getItem('settings');
      if (!settings) {
        output.innerHTML = '<span class="error">âŒ Firebase ì„¤ì • ì—†ìŒ</span>';
        return;
      }

      try {
        const parsed = JSON.parse(settings);
        if (parsed.firebaseConfig) {
          output.innerHTML = '<span class="success">âœ… Firebase ì„¤ì • ìˆìŒ</span>\n' +
            JSON.stringify(parsed.firebaseConfig, null, 2);
        } else {
          output.innerHTML = '<span class="error">âŒ Firebase ì„¤ì •ì´ settingsì— ì—†ìŒ</span>';
        }
      } catch (e) {
        output.innerHTML = `<span class="error">âŒ íŒŒì‹± ì‹¤íŒ¨: ${e.message}</span>`;
      }
    }

    async function checkRecovery() {
      const output = document.getElementById('recovery-output');
      let html = '<span class="warning">âš ï¸ ë³µêµ¬ ê°€ëŠ¥í•œ ë°ì´í„° ê²€ìƒ‰ ì¤‘...</span>\n\n';

      // ë‹¤ì–‘í•œ ê°€ëŠ¥í•œ í‚¤ í˜•ì‹ í™•ì¸
      const possiblePrefixes = [
        'daily_plans_',
        'dailyPlans_',
        'daily-plans-',
        'timeblock_',
        'tasks_',
      ];

      let found = false;
      possiblePrefixes.forEach(prefix => {
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith(prefix)) {
            found = true;
            html += `<span class="success">âœ… ë°œê²¬: ${key}</span>\n`;
          }
        });
      });

      if (!found) {
        html += '<span class="error">âŒ ë³µêµ¬ ê°€ëŠ¥í•œ ë°ì´í„° ì—†ìŒ</span>\n';
      }

      output.innerHTML = html;
    }

    async function diagnoseAll() {
      await checkLocalStorage();
      await checkIndexedDB();
      await checkFirebase();
      await checkRecovery();
    }

    function exportData() {
      const data = {
        localStorage: {},
        timestamp: new Date().toISOString(),
      };

      Object.keys(localStorage).forEach(key => {
        data.localStorage[key] = localStorage.getItem(key);
      });

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `timeblock-backup-${Date.now()}.json`;
      a.click();

      alert('ë°ì´í„°ê°€ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ìë™ ì‹¤í–‰
    window.onload = diagnoseAll;
  </script>
</body>
</html>
