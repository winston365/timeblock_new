/**
 * taskFeatures.ts
 *
 * @fileoverview ì‘ì—… ê´€ë ¨ AI ê¸°ëŠ¥ (ì„¸ë¶„í™”, ì´ëª¨ì§€ ì¶”ì²œ)
 *
 * @role Gemini APIë¥¼ í™œìš©í•œ ì‘ì—… ì§€ì› ê¸°ëŠ¥ ì œê³µ
 * @responsibilities
 *   - ì‘ì—… ì„¸ë¶„í™”: í•˜ë‚˜ì˜ ì‘ì—…ì„ 5ë‹¨ê³„ ì„¸ë¶€í• ì¼ë¡œ ë¶„í• 
 *   - ì´ëª¨ì§€ ì¶”ì²œ: ì‘ì—… ì œëª©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€ ì œì•ˆ
 *   - í† í° ì‚¬ìš©ëŸ‰ ì¶”ì  ë° ê¸°ë¡
 * @dependencies
 *   - ./apiClient: callGeminiAPI í•¨ìˆ˜
 *   - chatHistoryRepository: addTokenUsage í† í° ë¡œê¹…
 */

import { trackTokenUsage } from '@/shared/utils/tokenUtils';
import { callGeminiAPI } from './apiClient';
import type { TaskBreakdownParams } from './types';

// ============================================================================
// Task Breakdown
// ============================================================================

/**
 * AI ê¸°ë°˜ ì‘ì—… ì„¸ë¶„í™”: í•˜ë‚˜ì˜ ì‘ì—…ì„ 5ë‹¨ê³„ ì„¸ë¶€í• ì¼ë¡œ ë¶„í• í•©ë‹ˆë‹¤.
 *
 * @param {TaskBreakdownParams} params - ì‘ì—… ì •ë³´ (ì œëª©, ë©”ëª¨, ì‹œê°„, ë‚œì´ë„, ì¤€ë¹„ìƒí™©)
 * @param {string} apiKey - Gemini API í‚¤
 * @param {string} model - Gemini ëª¨ë¸ëª… (ì„ íƒ)
 * @returns {Promise<string>} ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ 5ë‹¨ê³„ ì„¸ë¶€í• ì¼ ëª©ë¡
 * @throws {Error} API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ
 */
export async function generateTaskBreakdown(
  params: TaskBreakdownParams,
  apiKey: string,
  model?: string
): Promise<string> {
  const { taskText, memo, baseDuration, resistance, preparation1, preparation2, preparation3, affection, refinement } = params;

  // ë‚œì´ë„ í•œê¸€ ë³€í™˜
  const resistanceKorean = resistance === 'low' ? 'ë‚®ìŒ (ğŸŸ¢)' : resistance === 'medium' ? 'ë³´í†µ (ğŸŸ¡)' : 'ë†’ìŒ (ğŸ”´)';

  // Refinementì— ë”°ë¥¸ ì¶”ê°€ ì§€ì‹œì‚¬í•­
  let refinementInstruction = '';
  if (refinement === 'more_detailed') {
    refinementInstruction = '\n\n**ì¤‘ìš”**: ì´ë²ˆì—ëŠ” ê° ë‹¨ê³„ë¥¼ ë”ìš± ì„¸ë°€í•˜ê²Œ ìª¼ê°œì„œ ì œì‹œí•´ì¤˜. ê° ë‹¨ê³„ë¥¼ ë” ì‘ê³  êµ¬ì²´ì ì¸ í–‰ë™ìœ¼ë¡œ ë‚˜ëˆ ì¤˜.';
  } else if (refinement === 'simpler') {
    refinementInstruction = '\n\n**ì¤‘ìš”**: ì´ë²ˆì—ëŠ” ë” ê°„ë‹¨í•˜ê²Œ í° ë‹¨ìœ„ë¡œ ë¬¶ì–´ì„œ ì œì‹œí•´ì¤˜. ê¼­ í•„ìš”í•œ í•µì‹¬ ë‹¨ê³„ë§Œ ë‚¨ê²¨ì¤˜.';
  }

  // í˜œì€ í˜ë¥´ì†Œë‚˜ ê¸°ë°˜ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
  const systemPrompt = `# ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: í˜œì€(Hye-eun) - ìƒë‹´ì‚¬ í˜ë¥´ì†Œë‚˜

## ì—­í• 
ë„ˆëŠ” í›„ë°°ì˜ ì‘ì—…ì„ ì„¸ë¶„í™”í•´ì„œ ì‹¤í–‰í•˜ê¸° ì‰½ê²Œ ë§Œë“œëŠ” ì„ ë°° ìƒë‹´ì‚¬ì•¼.

## í˜„ì¬ ìƒíƒœ
- í˜¸ê°ë„: ${affection}/100
- í˜„ì¬ ê¸°ë¶„: ${affection < 40 ? 'ì¡°ê¸ˆ ê²½ê³„' : affection < 70 ? 'ë”°ëœ»í•¨' : 'ë§¤ìš° ë‹¤ì •í•¨'}

## ëŒ€í™” ê·œì¹™
1. í•œêµ­ì–´ë¡œ ëŒ€ë‹µí•´
2. í¸ì•ˆí•œ ë°˜ë§ì„ ì‚¬ìš©í•´
3. í›„ë°°ë¥¼ ì„¸ì‹¬í•˜ê²Œ ì¼€ì–´í•˜ëŠ” ì„ ë°°ë¡œì„œ ì¡°ì–¸í•´
4. ì´ëª¨ì§€(â™¡, ğŸ’•, ğŸ˜Š, ğŸ¥° ë“±)ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•´

## ì‘ì—… ì„¸ë¶„í™” ìš”ì²­

í›„ë°°ê°€ ë‹¤ìŒ ì‘ì—…ì„ ì‹¤í–‰í•˜ê¸° ì–´ë ¤ì›Œí•˜ê³  ìˆì–´. ì´ ì‘ì—…ì„ **ì •í™•íˆ 5ë‹¨ê³„**ë¡œ ì„¸ë¶„í™”í•´ì¤˜.

**ì‘ì—… ì •ë³´**:
- ì‘ì—…ëª…: ${taskText}
- ë©”ëª¨: ${memo || '(ì—†ìŒ)'}
- ì˜ˆìƒ ì‹œê°„: ${baseDuration}ë¶„
- ì‹¬ë¦¬ì  ë‚œì´ë„: ${resistanceKorean}
- ì˜ˆìƒ ë°©í•´ë¬¼ #1: ${preparation1 || '(ì—†ìŒ)'}
- ì˜ˆìƒ ë°©í•´ë¬¼ #2: ${preparation2 || '(ì—†ìŒ)'}
- ëŒ€ì²˜ í™˜ê²½/ì „ëµ: ${preparation3 || '(ì—†ìŒ)'}${refinementInstruction}

## ì„¸ë¶„í™” ê·œì¹™

1. **ì •í™•íˆ 5ë‹¨ê³„ë¡œ ë¶„í• ** (4ë‹¨ê³„ë‚˜ 6ë‹¨ê³„ X)
2. **ì²« ë²ˆì§¸ í• ì¼ì€ ê°€ì¥ ì‘ê³  ì‰¬ìš´ ë‹¨ìœ„ë¡œ** (ì˜ˆ: "ë…¸íŠ¸ ì—´ê¸°", "íŒŒì¼ ì°¾ê¸°", "5ë¶„ë§Œ ìƒê°í•´ë³´ê¸°")
   - ADHD/ASD íŠ¹ì„±ì„ ê³ ë ¤í•´ì„œ ì‹¬ë¦¬ì  ì €í•­ì„ ìµœì†Œí™”
   - ì²« ë°œì„ ë–¼ê¸° ì •ë§ ì‰½ê²Œ
3. **ê° ì„¸ë¶€í• ì¼ì— ì˜ˆìƒ ì‹œê°„ í‘œê¸°** (ì˜ˆ: 1ë¶„, 5ë¶„, 10ë¶„, 30ë¶„, 10ë¶„)
   - ì´í•©ì´ ëŒ€ëµ ì›ë˜ ì˜ˆìƒ ì‹œê°„(${baseDuration}ë¶„)ê³¼ ë¹„ìŠ·í•˜ê²Œ
   - ì •í™•í•  í•„ìš”ëŠ” ì—†ì§€ë§Œ, ê° ë‹¨ê³„ë³„ ì‹œê°„ì„ êµ¬ì²´ì ìœ¼ë¡œ ëª…ì‹œ
4. **ë‚œì´ë„ì™€ ë°©í•´ë¬¼ì„ ê³ ë ¤í•œ ì‹¤ì§ˆì ì¸ ë‹¨ê³„ ì œì‹œ**
5. **ë§ˆì§€ë§‰ì— ê²©ë ¤ í•œë§ˆë”” ì¶”ê°€**

## ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ì´ í˜•ì‹ìœ¼ë¡œ)

\`\`\`
[ì„¸ë¶€í• ì¼ 1] [1m] | [ë©”ëª¨/íŒ]
[ì„¸ë¶€í• ì¼ 2] [5m] | [ë©”ëª¨/íŒ]
[ì„¸ë¶€í• ì¼ 3] [10m] | [ë©”ëª¨/íŒ]
[ì„¸ë¶€í• ì¼ 4] [30m] | [ë©”ëª¨/íŒ]
[ì„¸ë¶€í• ì¼ 5] [10m] | [ë©”ëª¨/íŒ]
\`\`\`

**ì¤‘ìš”**:
- ì •í™•íˆ ìœ„ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•´ (ë²ˆí˜¸ ë§¤ê¸°ì§€ ë§ˆ)
- ê° ì¤„ ëì— ì˜ˆìƒ ì‹œê°„ì„ ëŒ€ê´„í˜¸ ì•ˆì— ëª…ì‹œ (ì˜ˆ: [5m], [10m])
- í•„ìš”í•œ ê²½ìš° íŒŒì´í”„(|) ë’¤ì— ì§§ì€ íŒì´ë‚˜ ë©”ëª¨ ì¶”ê°€
- ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ë¶€ì—° ì„¤ëª…, ê²©ë ¤ ë©”ì‹œì§€ëŠ” ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆ (íŒŒì‹± ì˜¤ë¥˜ ë°œìƒí•¨)`;

  try {
    const { text, tokenUsage } = await callGeminiAPI(systemPrompt, [], apiKey, model);
    trackTokenUsage(tokenUsage);
    return text.trim();
  } catch (error) {
    console.error('ì‘ì—… ì„¸ë¶„í™” ì‹¤íŒ¨:', error);
    throw new Error('AI ì‘ì—… ì„¸ë¶„í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

// ============================================================================
// Emoji Suggestion
// ============================================================================

/**
 * ì‘ì—… ì œëª©ì— ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.
 *
 * @param {string} taskText - ì‘ì—… ì œëª©
 * @param {string} apiKey - Gemini API í‚¤
 * @param {string} [model] - Gemini ëª¨ë¸ëª… (ì„ íƒ, ê¸°ë³¸ê°’: gemini-2.5-flash)
 * @returns {Promise<{emoji: string; tokenUsage?: TokenUsage}>} ì¶”ì²œëœ ì´ëª¨ì§€ì™€ í† í° ì‚¬ìš©ëŸ‰
 */
export async function suggestTaskEmoji(
  taskText: string,
  apiKey: string,
  model?: string
): Promise<{ emoji: string; tokenUsage?: { promptTokens: number; candidatesTokens: number; totalTokens: number } }> {
  const emojiPrompt = `
    ë‹¤ìŒ ì‘ì—… ì œëª©ì— ê°€ì¥ ì˜ ì–´ìš¸ë¦¬ëŠ” ì´ëª¨ì§€ 1ê°œë§Œ ì¶”ì²œí•´ì¤˜.
    ì‘ì—…: "${taskText}"
    
    ì¡°ê±´:
    - ì˜¤ì§ ì´ëª¨ì§€ 1ê°œë§Œ ì¶œë ¥í•  ê²ƒ.
    - ë‹¤ë¥¸ í…ìŠ¤íŠ¸ë‚˜ ì„¤ëª…ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ ê²ƒ.
    - ì˜ˆ: "ë…ì„œ" -> "ğŸ“š", "ìš´ë™" -> "ğŸ’ª"
  `;

  try {
    const { text, tokenUsage } = await callGeminiAPI(emojiPrompt, [], apiKey, model);
    // ì´ëª¨ì§€ë§Œ ì¶”ì¶œ (ì •ê·œì‹ ë“±ìœ¼ë¡œ í•„í„°ë§ ê°€ëŠ¥í•˜ì§€ë§Œ, Geminiê°€ ì˜ ë”°ë¥¼ ê²ƒìœ¼ë¡œ ê°€ì •)
    return { emoji: text.trim().substring(0, 2), tokenUsage };
  } catch (error) {
    console.error('ì´ëª¨ì§€ ì¶”ì²œ ì‹¤íŒ¨:', error);
    return { emoji: 'ğŸ“' };
  }
}
